# ä»£ç†å’Œåå°„

## ä»£ç† Proxy

å¯ä»¥ç»™ç›®æ ‡å¯¹è±¡å®šä¹‰ä¸€ä¸ªå…³è”çš„ä»£ç†å¯¹è±¡ï¼Œè€Œè¿™ä¸ªä»£ç†å¯¹è±¡å¯ä»¥ä½œä¸ºæŠ½è±¡çš„ç›®æ ‡å¯¹è±¡æ¥ä½¿ç”¨ã€‚åœ¨å¯¹ç›®æ ‡å¯¹è±¡çš„å„ç§æ“ä½œå½±å“ç›®æ ‡å¯¹è±¡ä¹‹å‰ï¼Œå¯ä»¥åœ¨ä»£ç†å¯¹è±¡ä¸­å¯¹è¿™äº›æ“ä½œåŠ ä»¥æ§åˆ¶ã€‚

> ä»£ç†æ˜¯ç›®æ ‡å¯¹è±¡çš„æŠ½è±¡

## åˆ›å»ºä»£ç†

> ä»£ç†æ˜¯ä½¿ç”¨ Proxy æ„é€ å‡½æ•°åˆ›å»ºçš„ã€‚è¿™ä¸ªæ„é€ å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šç›®æ ‡å¯¹è±¡å’Œå¤„ç†ç¨‹åºå¯¹è±¡

```javascript
// 1. ç›®æ ‡å¯¹è±¡
const target = {
  id: 'target'
};
// 2. å¤„ç†ç¨‹åºå¯¹è±¡
const handler = {};

// 3. åˆ›å»ºä»£ç†
const proxy = new Proxy(target, handler);

// id å±æ€§ä¼šè®¿é—®åŒä¸€ä¸ªå€¼ 
console.log(target);  // target 
console.log(proxy);   // target 

// ç»™ç›®æ ‡å±æ€§èµ‹å€¼ä¼šåæ˜ åœ¨ä¸¤ä¸ªå¯¹è±¡ä¸Š 
// å› ä¸ºä¸¤ä¸ªå¯¹è±¡è®¿é—®çš„æ˜¯åŒä¸€ä¸ªå€¼ 
target.id = 'foo';
console.log(target.id); // foo 
console.log(proxy.id);  // foo 

// ç»™ä»£ç†å±æ€§èµ‹å€¼ä¼šåæ˜ åœ¨ä¸¤ä¸ªå¯¹è±¡ä¸Š 
// å› ä¸ºè¿™ä¸ªèµ‹å€¼ä¼šè½¬ç§»åˆ°ç›®æ ‡å¯¹è±¡ 
proxy.id = 'bar';
console.log(target.id); // bar 
console.log(proxy.id);  // bar 

// hasOwnProperty()æ–¹æ³•åœ¨ä¸¤ä¸ªåœ°æ–¹ 
// éƒ½ä¼šåº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡ 
console.log(target.hasOwnProperty('id')); // true 
console.log(proxy.hasOwnProperty('id'));  // true 

// ä¸¥æ ¼ç›¸ç­‰å¯ä»¥ç”¨æ¥åŒºåˆ†ä»£ç†å’Œç›®æ ‡ 
console.log(target === proxy); // false 
```

## æ•è·å™¨ trap

> æ•è·å™¨å°±æ˜¯åœ¨å¤„ç†ç¨‹åºå¯¹è±¡ (handler) ä¸­å®šä¹‰çš„â€œåŸºæœ¬æ“ä½œçš„æ‹¦æˆªå™¨â€

```javascript
// ç›®æ ‡å¯¹è±¡
const target = {
  foo: 'bar'
};

// å¤„ç†ç¨‹åºå¯¹è±¡
const handler = {
  // å®šä¹‰ä¸€ä¸ª get() æ•è·å™¨ï¼Œæ•è·å™¨åœ¨å¤„ç†ç¨‹åºå¯¹è±¡ä¸­ä»¥æ–¹æ³•åä¸ºé”®
  get() {
    return 'handler override';
  }
};

// åˆ›å»ºä»£ç†
const proxy = new Proxy(target, handler); 

console.log(target.foo);  // bar 
console.log(proxy.foo);   // handler override

// get() æ•è·å™¨ä¼šæ¥æ”¶åˆ°ç›®æ ‡å¯¹è±¡ã€è¦æŸ¥è¯¢çš„å±æ€§å’Œä»£ç†å¯¹è±¡ä¸‰ä¸ªå‚æ•°
get(trapTarget, property, receiver) {};
```

> æœ‰äº†ä¸‰ä¸ªå‚æ•°ï¼Œé‡å»ºè¢«æ•è·æ–¹æ³•çš„åŸå§‹è¡Œä¸º

```javascript
// é‡å»ºè¢«æ•è·æ–¹æ³•çš„åŸå§‹è¡Œä¸º
const target = {
  foo: 'bar'
};
const handler = {
  get(trapTarget, property, receiver) {
    return trapTarget[property];
  }
};
const proxy = new Proxy(target, handler);
console.log(proxy.foo);  // bar 
console.log(target.foo); // bar 
```

## åå°„ Reflect

> å¤„ç†ç¨‹åºå¯¹è±¡ä¸­æ‰€æœ‰å¯ä»¥æ•è·çš„æ–¹æ³•éƒ½æœ‰å¯¹åº”çš„åå°„ï¼ˆReflectï¼‰API æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•ä¸æ•è·å™¨æ‹¦æˆªçš„æ–¹æ³•å…·æœ‰ç›¸åŒçš„åç§°å’Œå‡½æ•°ç­¾åï¼Œè€Œä¸”ä¹Ÿå…·æœ‰ä¸è¢«æ‹¦æˆªæ–¹æ³•ç›¸åŒçš„è¡Œä¸ºã€‚
>
> åå°„å¯ä»¥æ›´æ–¹ä¾¿ç¨‹åºå‘˜é‡å»ºè¢«æ•è·æ–¹æ³•çš„åŸå§‹è¡Œä¸º (ä¿®æ”¹æ•è·æ–¹æ³•)

```javascript
// ç›®æ ‡å¯¹è±¡
const target = {
  foo: 'bar'
};

// å¤„ç†ç¨‹åºå¯¹è±¡
const handler = {
  get() {
    console.log('ğŸš€ğŸš€ğŸš€ : ', ...arguments);
    // æ‰“å° { foo: 'bar' } foo { foo: 'bar' }
    // åˆ†åˆ«å¯¹åº” ç›®æ ‡å¯¹è±¡ï¼ŒæŸ¥è¯¢çš„å±æ€§ï¼Œä»£ç†å¯¹è±¡
    return Reflect.get(...arguments);
  }
};

// åˆ›å»ºä»£ç†
const proxy = new Proxy(target, handler);

console.log(proxy.foo);   // bar 
console.log(target.foo);  // bar 

// ç®€å†™
const proxy = new Proxy(target, Reflect); 
```

```javascript
// ä½¿ç”¨åå°„é‡å»ºè¢«æ•è·æ–¹æ³•çš„åŸå§‹è¡Œä¸º
const target = {
  foo: 'bar',
  baz: 'qux'
};

const handler = {
  get(trapTarget, property, receiver) {
    let decoration = '';
    if (property === 'foo') {
      decoration = '!!!';
    }
    return Reflect.get(...arguments) + decoration;
  }
};

const proxy = new Proxy(target, handler);

console.log(proxy.foo);   // bar!!! 
console.log(target.foo);  // bar 
console.log(proxy.baz);   // qux 
console.log(target.baz);  // qux 
```

## ä»£ç†æ•è·å™¨ä¸åå°„æ–¹æ³•

> ä»£ç†å¯ä»¥æ•è· 13 ç§ä¸åŒçš„åŸºæœ¬æ“ä½œ

* `get(target, property, receiver)`
* `set(target, property, value, receiver)`
* `has(target, property)`
* `defineProperty(target, property, descriptor)`
* `getOwnPropertyDescriptor()`
* `deleteProperty()`
* `ownKeys()`
* `getPrototypeOf()`
* `setPrototypeOf()`
* `isExtensible()`
* `preventExtensions()`
* `apply()`
* `construct()`

## ä»£ç†æ¨¡å¼

1ï¸âƒ£ è·Ÿè¸ªå±æ€§è®¿é—®

> é€šè¿‡æ•è· getã€set å’Œ has ç­‰æ“ä½œï¼Œå¯ä»¥çŸ¥é“å¯¹è±¡å±æ€§ä»€ä¹ˆæ—¶å€™è¢«è®¿é—®ã€è¢«æŸ¥è¯¢ã€‚

```javascript
const user = {
  name: 'Jake'
};

const proxy = new Proxy(user, {
  get(target, property, receiver) {
    console.log(`Getting ${property}`);
    return Reflect.get(...arguments);
  },
  set(target, property, value, receiver) {
    console.log(`Setting ${property}=${value}`);
    return Reflect.set(...arguments);
  }
});

proxy.name;     // Getting name
proxy.age = 27; // Setting age=27
```

2ï¸âƒ£ éšè—å±æ€§

> ä»£ç†çš„å†…éƒ¨å®ç°å¯¹å¤–éƒ¨ä»£ç æ˜¯ä¸å¯è§çš„ï¼Œå› æ­¤è¦éšè—ç›®æ ‡å¯¹è±¡ä¸Šçš„å±æ€§ä¹Ÿè½»è€Œæ˜“ä¸¾ã€‚

```javascript
const hiddenProperties = ['foo', 'bar'];
const targetObject = {
  foo: 1,
  bar: 2,
  baz: 3
};
const proxy = new Proxy(targetObject, {
  get(target, property) {
    if (hiddenProperties.includes(property)) {
      return undefined;
    } else {
      return Reflect.get(...arguments);
    }
  },
  has(target, property) {
    if (hiddenProperties.includes(property)) {
      return false;
    } else {
      return Reflect.has(...arguments);
    }
  }
});
// get()
console.log(proxy.foo);  // undefined
console.log(proxy.bar);  // undefined
console.log(proxy.baz);  // 3 
// has()
console.log('foo' in proxy);  // false
console.log('bar' in proxy);  // false
console.log('baz' in proxy);  // true 
```

3ï¸âƒ£ å±æ€§éªŒè¯

4ï¸âƒ£ å‡½æ•°ä¸æ„é€ å‡½æ•°å‚æ•°éªŒè¯

5ï¸âƒ£ æ•°æ®ç»‘å®šä¸å¯è§‚å¯Ÿå¯¹è±¡

> é€šè¿‡ä»£ç†å¯ä»¥æŠŠè¿è¡Œæ—¶ä¸­åŸæœ¬ä¸ç›¸å…³çš„éƒ¨åˆ†è”ç³»åˆ°ä¸€èµ·ã€‚è¿™æ ·å°±å¯ä»¥å®ç°å„ç§æ¨¡å¼ï¼Œä»è€Œè®©ä¸åŒçš„
> ä»£ç äº’æ“ä½œã€‚

```javascript
const userList = [];

class User {
  constructor(name) {
    this.name_ = name;
  }
}

const proxy = new Proxy(User, {
  construct() {
    const newUser = Reflect.construct(...arguments);
    userList.push(newUser);
    return newUser;
  }
});

new proxy('John');
new proxy('Jacob');
new proxy('Jingleheimerschmidt');
console.log(userList); // [User {}, User {}, User{}] 
```

> æŠŠé›†åˆç»‘å®šåˆ°ä¸€ä¸ªäº‹ä»¶åˆ†æ´¾ç¨‹åºï¼Œæ¯æ¬¡æ’å…¥æ–°å®ä¾‹æ—¶éƒ½ä¼šå‘é€æ¶ˆæ¯

```javascript
const userList = [];

function emit(newValue) {
  console.log(newValue);
}

const proxy = new Proxy(userList, {
  set(target, property, value, receiver) {
    const result = Reflect.set(...arguments);
    // Vue 3 å°±æ˜¯åœ¨è¿™é‡Œæ‰§è¡Œè§£ææ¨¡æ¿çš„æ“ä½œå§
    if (result) {
      emit(Reflect.get(target, property, receiver));
    }
    return result;
  }
});

proxy.push('John'); // John proxy.push('Jacob'); // Jacob 
```


